<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MONAD EXIT CONTRACT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #0f0529, #1a0b3d); color: white; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
    .glow { box-shadow: 0 0 30px rgba(139, 92, 246, 0.6); }
    .btn-glow:hover { box-shadow: 0 0 40px rgba(139, 92, 246, 0.8); }
  </style>
</head>
<body class="flex items-center justify-center p-6">

<div class="w-full max-w-2xl">

  <h1 class="text-6xl font-bold text-center mb-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
    MONAD EXIT CONTRACT
  </h1>
  <p class="text-center text-gray-300 mb-10">Deposit MON — Exit anytime. No admins. Pure on-chain.</p>

  <!-- Wallet Connect Button -->
  <div id="walletSection" class="text-center mb-12">
    <button id="connectBtn" class="px-10 py-5 text-xl font-bold rounded-2xl bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 transition btn-glow">
      Connect Wallet (Monad Mainnet)
    </button>
    <p id="walletAddress" class="mt-6 text-lg"></p>
    <p id="wrongNetwork" class="mt-4 text-red-400 text-lg font-bold hidden">
      Wrong network! Switching to Monad Mainnet...
    </p>
  </div>

  <!-- Main App (hidden until connected & correct chain) -->
  <div id="app" class="hidden space-y-8">

    <div class="grid md:grid-cols-2 gap-8">
      <!-- Deposit -->
      <div class="bg-white/5 backdrop-blur-lg rounded-3xl p-8 border border-purple-500/30 glow">
        <h2 class="text-3xl font-bold mb-6">Deposit MON</h2>
        <input id="amountInput" type="text" placeholder="0.42" class="w-full bg-white/10 rounded-xl px-5 py-4 text-xl mb-6 focus:outline-none focus:ring-4 focus:ring-purple-500"/>
        <button id="depositBtn" class="w-full py-5 text-xl font-bold rounded-xl bg-green-600 hover:bg-green-700 transition btn-glow">
          Deposit MON
        </button>
        <p class="mt-6 text-lg">Your deposited: <span id="userBal" class="font-bold text-green-400">0</span> MON</p>
      </div>

      <!-- Exit -->
      <div class="bg-white/5 backdrop-blur-lg rounded-3xl p-8 border border-red-500/30 glow">
        <h2 class="text-3xl font-bold mb-6 text-red-400">Exit (Withdraw)</h2>
        <button id="exitBtn" class="w-full py-5 text-xl font-bold rounded-xl bg-red-600 hover:bg-red-700 transition btn-glow">
          Exit Now — Get All MON Back
        </button>
        <p class="mt-6 text-lg">You will receive: <span id="exitBal" class="font-bold text-red-400">0</span> MON</p>
      </div>
    </div>

    <div class="text-center">
      <p class="text-xl">Total locked in contract: <span id="totalLocked" class="font-bold text-yellow-400">0</span> MON</p>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-16 text-center text-gray-400 text-sm">
    Contract: <code class="break-all text-purple-300">0xc6c0db193c8f590ae8e80b8c7aCcdB1BC5A4E9c3</code><br><br>
    <a href="https://monad-vision.vercel.app/address/0xc6c0db193c8f590ae8e80b8c7aCcdB1BC5A4E9c3" target="_blank" class="underline hover:text-white">
      View on Monad Explorer
    </a>
  </div>
</div>

<script>
// YOUR REAL CONTRACT ON MONAD MAINNET
const CONTRACT_ADDRESS = "0xc6c0db193c8f590ae8e80b8c7aCcdB1BC5A4E9c3";

const ABI = [
  "function deposit() payable",
  "function exit()",
  "function balances(address) view returns (uint256)",
  "function totalDeposited() view returns (uint256)"
];

// Monad Mainnet config (forced)
const MONAD_MAINNET = {
  chainId: "0x8f", // 143
  chainName: "Monad Mainnet",
  nativeCurrency: { name: "Monad", symbol: "MON", decimals: 18 },
  rpcUrls: ["https://rpc.monad.xyz", "https://monad-mainnet.g.alchemy.com/v2/demo"],
  blockExplorerUrls: ["https://monad-vision.vercel.app"]
};

let provider, signer, contract, userAddress;

async function forceMonadNetwork() {
  try {
    await ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: MONAD_MAINNET.chainId }],
    });
  } catch (switchError) {
    if (switchError.code === 4902 || switchError.code === -32603) {
      // Network not added → add it
      await ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [MONAD_MAINNET],
      });
    } else {
      throw switchError;
    }
  }
}

async function connectWallet() {
  if (!window.ethereum) {
    alert("MetaMask or another wallet is required!");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);

  // FORCE Monad Mainnet
  document.getElementById("wrongNetwork").classList.remove("hidden");
  await forceMonadNetwork();
  document.getElementById("wrongNetwork").classList.add("hidden");

  // Request accounts
  await provider.send("eth_requestAccounts", []);

  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

  // UI updates
  document.getElementById("walletAddress").innerHTML = `
    Connected: <span class="text-purple-400 font-bold">${userAddress.slice(0,8)}...${userAddress.slice(-6)}</span>
  `;
  document.getElementById("walletSection").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");

  await refreshBalances();
  setupButtons();
}

async function refreshBalances() {
  const bal = await contract.balances(userAddress);
  const total = await contract.totalDeposited();

  document.getElementById("userBal").textContent = ethers.utils.formatEther(bal);
  document.getElementById("exitBal").textContent = ethers.utils.formatEther(bal);
  document.getElementById("totalLocked").textContent = ethers.utils.formatEther(total);
}

function setupButtons() {
  document.getElementById("depositBtn").onclick = async () => {
    const amount = document.getElementById("amountInput").value;
    if (!amount || Number(amount) <= 0) return alert("Enter a valid amount");

    const wei = ethers.utils.parseEther(amount);
    try {
      const tx = await contract.deposit({ value: wei });
      alert("Sending transaction...");
      await tx.wait();
      alert("Deposited " + amount + " MON!");
      refreshBalances();
    } catch (e) {
      alert("Failed: " + (e.message || e));
    }
  };

  document.getElementById("exitBtn").onclick = async () => {
    const bal = await contract.balances(userAddress);
    if (bal.eq(0)) return alert("You have nothing to exit");

    try {
      const tx = await contract.exit();
      alert("Withdrawing your MON...");
      await tx.wait();
      alert("Success! All MON returned.");
      refreshBalances();
    } catch (e) {
      alert("Exit failed: " + (e.message || e));
    }
  };
}

// Auto-connect if already on Monad and wallet is connected
window.addEventListener('load', async () => {
  if (window.ethereum) {
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId === MONAD_MAINNET.chainId) {
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length > 0) {
        connectWallet();
      }
    }
  }
});

document.getElementById("connectBtn").onclick = connectWallet;
</script>
</body>
</html>
