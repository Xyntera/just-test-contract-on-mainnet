<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Monad Exit Contract: Securely deposit and withdraw MON on Monad Mainnet. Professional DeFi tool with gas estimation and polished UI.">
  <title>Monad Exit Contract - Professional DeFi Tool</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÄ</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff2a6d;
      --secondary: #ff6b9d;
      --glass-bg: rgba(255, 255, 255, 0.15);
      --border-color: rgba(255, 255, 255, 0.3);
      --shadow: 0 20px 60px rgba(255, 42, 109, 0.1);
      --text-primary: #1f2937;
    }
    * { font-family: 'Inter', sans-serif; }
    body {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }
    .glass:hover { box-shadow: 0 25px 80px rgba(255, 42, 109, 0.15); }
    .gradient-text {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .btn-primary {
      background: linear-gradient(to right, var(--primary), var(--secondary));
      color: white;
      transition: all 0.3s ease;
      border: none;
    }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(255, 42, 109, 0.3); }
    .btn-secondary { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
    .btn-secondary:hover { background: var(--primary); color: white; }
    .loading { opacity: 0.8; pointer-events: none; }
    .spinner { border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .toast { position: fixed; top: 20px; right: 20px; z-index: 1000; padding: 16px 24px; border-radius: 12px; color: white; font-weight: 500; transform: translateX(400px); transition: transform 0.3s ease; }
    .toast.show { transform: translateX(0); }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .input-focus { box-shadow: 0 0 0 3px rgba(255, 42, 109, 0.1); }
    .gas-info { font-size: 0.875rem; color: #6b7280; }
  </style>
</head>
<body class="px-4 py-8 md:py-12">

  <!-- Toast Container -->
  <div id="toastContainer"></div>

  <!-- Header -->
  <header class="text-center mb-12">
    <h1 class="text-5xl md:text-7xl font-bold tracking-tight gradient-text mb-4">Monad Exit</h1>
    <p class="text-lg md:text-xl text-gray-600 max-w-2xl mx-auto leading-relaxed">
      Professional DeFi tool for secure MON deposits and instant withdrawals on Monad Mainnet. With real-time gas estimation and polished UX.
    </p>
  </header>

  <!-- Wallet Connect Section -->
  <section id="connectSection" class="max-w-4xl mx-auto mb-16">
    <div class="glass rounded-3xl p-8 md:p-12 text-center">
      <h2 class="text-3xl md:text-4xl font-semibold mb-6 text-gray-800">Connect Your Wallet</h2>
      <p class="text-gray-600 mb-8">Select a wallet to interact with the contract on Monad Mainnet (Chain ID: 143). Gas fees are estimated in real-time.</p>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6 max-w-3xl mx-auto">
        <!-- MetaMask -->
        <button id="metamaskBtn" class="glass rounded-2xl p-6 hover:scale-105 transition-all border border-gray-200/50">
          <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="w-12 h-12 mx-auto mb-3" alt="MetaMask">
          <p class="font-medium text-gray-700">MetaMask</p>
        </button>
        <!-- WalletConnect -->
        <button id="wcBtn" class="glass rounded-2xl p-6 hover:scale-105 transition-all border border-gray-200/50">
          <i class="fas fa-wallet text-2xl text-gray-700 mx-auto mb-3 block"></i>
          <p class="font-medium text-gray-700">WalletConnect</p>
        </button>
        <!-- Rainbow -->
        <button id="rainbowBtn" class="glass rounded-2xl p-6 hover:scale-105 transition-all border border-gray-200/50">
          <i class="fas fa-palette text-2xl text-indigo-500 mx-auto mb-3 block"></i>
          <p class="font-medium text-gray-700">Rainbow</p>
        </button>
        <!-- Coinbase -->
        <button id="coinbaseBtn" class="glass rounded-2xl p-6 hover:scale-105 transition-all border border-gray-200/50">
          <img src="https://www.coinbase.com/assets/app/favicon-32x32.png" class="w-10 h-10 mx-auto mb-3" alt="Coinbase">
          <p class="font-medium text-gray-700">Coinbase</p>
        </button>
      </div>

      <p id="connectStatus" class="mt-6 text-sm text-gray-500"></p>
    </div>
  </section>

  <!-- Main App -->
  <main id="appSection" class="hidden max-w-6xl mx-auto">
    
    <!-- Connected Wallet Info -->
    <div class="glass rounded-2xl p-6 mb-10 text-center">
      <p class="text-gray-600 mb-2">Connected Address</p>
      <div class="flex items-center justify-center space-x-2 mb-4">
        <p id="walletAddress" class="text-xl font-mono break-all bg-gray-100 px-3 py-1 rounded-lg text-gray-700"></p>
        <button onclick="copyAddress()" class="text-gray-500 hover:text-gray-700 p-2 hover:bg-gray-200 rounded" title="Copy Address">
          <i class="fas fa-copy"></i>
        </button>
      </div>
      <button id="disconnectBtn" class="text-sm text-gray-500 underline hover:text-gray-700">Disconnect</button>
    </div>

    <!-- Action Cards -->
    <div class="grid lg:grid-cols-2 gap-8 mb-16">
      
      <!-- Deposit Card -->
      <div class="glass rounded-3xl p-8 md:p-12">
        <h3 class="text-4xl font-bold gradient-text mb-6">Deposit MON</h3>
        <div class="mb-6">
          <input 
            id="depositAmount" 
            type="number" 
            step="0.0001" 
            min="0.0001"
            placeholder="0.00" 
            class="w-full bg-white/30 border border-gray-300/50 rounded-2xl px-6 py-4 text-xl text-center focus:outline-none focus:ring-2 focus:ring-var(--primary) input-focus transition"
          >
        </div>
        <div id="depositGas" class="gas-info mb-4 hidden">
          <i class="fas fa-gas-pump mr-2"></i> Estimated Gas Fee: <span id="depositGasFee">0.0000</span> MON
        </div>
        <button id="depositBtn" class="w-full btn-primary py-4 rounded-2xl text-lg font-semibold mb-6 flex items-center justify-center space-x-2">
          <span>Deposit</span>
          <span id="depositSpinner" class="spinner hidden"></span>
        </button>
        <p class="text-center text-gray-600">
          Your Balance: <span id="userBalance" class="text-2xl font-bold gradient-text">0.0000</span> MON
        </p>
      </div>

      <!-- Exit Card -->
      <div class="glass rounded-3xl p-8 md:p-12">
        <h3 class="text-4xl font-bold gradient-text mb-6">Exit (Withdraw)</h3>
        <div id="exitGas" class="gas-info mb-4">
          <i class="fas fa-gas-pump mr-2"></i> Estimated Gas Fee: <span id="exitGasFee">0.0000</span> MON
        </div>
        <button id="exitBtn" class="w-full btn-primary py-4 rounded-2xl text-lg font-semibold mb-6 flex items-center justify-center space-x-2">
          <span>Withdraw All</span>
          <span id="exitSpinner" class="spinner hidden"></span>
        </button>
        <p class="text-center text-gray-600">
          Withdraw Amount: <span id="exitAmount" class="text-2xl font-bold gradient-text">0.0000</span> MON
        </p>
      </div>
    </div>

    <!-- Total Locked -->
    <div class="glass rounded-3xl p-8 md:p-12 text-center mb-16">
      <h3 class="text-2xl font-semibold text-gray-800 mb-4">Total MON Locked in Contract</h3>
      <div class="flex items-center justify-center mb-2">
        <span id="totalDeposited" class="text-6xl font-bold gradient-text">0.0000</span>
        <i class="fas fa-coins ml-2 text-3xl text-gray-400"></i>
      </div>
      <p class="text-sm text-gray-500">Real-time on-chain data from Monad Mainnet</p>
    </div>

    <!-- Contract Details -->
    <footer class="text-center text-gray-500 text-sm">
      <p>Contract Address: <code class="font-mono bg-gray-100 px-2 py-1 rounded text-gray-800">0xc6c0db193c8f590ae8e80b8c7aCcdB1BC5A4E9c3</code></p>
      <p class="mt-2">
        <a href="https://monad-vision.vercel.app/address/0xc6c0db193c8f590ae8e80b8c7aCcdB1BC5A4E9c3" target="_blank" class="underline hover:text-gray-700 flex items-center justify-center mx-auto">
          View on Monad Explorer <i class="fas fa-external-link-alt ml-1"></i>
        </a>
      </p>
      <p class="mt-4">Built with ‚ù§Ô∏è for Monad. Production-ready with gas optimization. Audit recommended.</p>
    </footer>
  </main>

<script>
// Configuration
const CONTRACT_ADDRESS = "0xc6c0db193c8f590ae8e80b8c7aCcdB1BC5A4E9c3";
const ABI = [
  "function deposit() payable",
  "function exit()",
  "function balances(address) view returns (uint256)",
  "function totalDeposited() view returns (uint256)"
];
const MONAD_CHAIN = {
  chainId: "0x8f", // 143
  chainName: "Monad Mainnet",
  nativeCurrency: { name: "Monad", symbol: "MON", decimals: 18 },
  rpcUrls: ["https://rpc.monad.xyz"],
  blockExplorerUrls: ["https://monad-vision.vercel.app"]
};

let provider, signer, contract, userAddress;

// Utility Functions
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.getElementById('toastContainer').appendChild(toast);
  setTimeout(() => toast.classList.add('show'), 100);
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function showLoading(buttonId, show = true) {
  const btn = document.getElementById(buttonId);
  const spinner = btn.querySelector('.spinner');
  if (show) {
    btn.classList.add('loading');
    spinner.classList.remove('hidden');
  } else {
    btn.classList.remove('loading');
    spinner.classList.add('hidden');
  }
}

function copyAddress() {
  navigator.clipboard.writeText(userAddress).then(() => showToast('Address copied to clipboard!'));
}

function formatEther(wei) {
  return parseFloat(ethers.utils.formatEther(wei)).toFixed(4);
}

// Gas Estimation
async function estimateGasAndFee(call, value = 0) {
  try {
    const gasEstimate = await call.estimateGas({ value });
    const feeData = await provider.getFeeData();
    const gasPrice = feeData.gasPrice || 0;
    const feeWei = gasEstimate.mul(gasPrice);
    return formatEther(feeWei);
  } catch (error) {
    console.error('Gas estimation failed:', error);
    return 'Error';
  }
}

// Network Switch
async function switchToMonad() {
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: MONAD_CHAIN.chainId }]
    });
  } catch (error) {
    if (error.code === 4902) {
      await window.ethereum.request({
        method: 'wallet_addEthereumChain',
        params: [MONAD_CHAIN]
      });
    } else {
      throw error;
    }
  }
}

// Connect Functions
async function connectInjected() {
  if (!window.ethereum) {
    showToast('MetaMask or compatible wallet required', 'error');
    return;
  }
  try {
    document.getElementById('connectStatus').textContent = 'Switching to Monad Mainnet...';
    await switchToMonad();
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    await initContract();
  } catch (error) {
    showToast(`Connection failed: ${error.message}`, 'error');
    document.getElementById('connectStatus').textContent = '';
  }
}

async function connectWalletConnect() {
  const { Modal } = WalletConnectModal;
  const modal = new Modal({
    projectId: 'YOUR_WALLETCONNECT_PROJECT_ID', // Replace with real ID from walletconnect.com
    themeMode: 'light'
  });
  try {
    const session = await modal.connect({
      requiredNamespaces: {
        eip155: {
          chains: ['eip155:143'],
          methods: ['eth_sendTransaction', 'eth_signTypedData', 'personal_sign'],
          events: ['chainChanged', 'accountsChanged']
        }
      }
    });
    provider = new ethers.providers.Web3Provider(new WalletConnectModal.EthereumProvider(session));
    await initContract();
    modal.closeModal();
  } catch (error) {
    showToast('WalletConnect failed', 'error');
  }
}

// Init Contract
async function initContract() {
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
  
  document.getElementById('walletAddress').textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
  document.getElementById('connectSection').classList.add('hidden');
  document.getElementById('appSection').classList.remove('hidden');
  
  loadBalances();
  setInterval(loadBalances, 10000); // Refresh every 10s
  
  // Initial gas estimates
  updateDepositGas();
  updateExitGas();
  
  showToast('Wallet connected successfully!');
  document.getElementById('connectStatus').textContent = '';
}

// Load Balances
async function loadBalances() {
  try {
    const [userBal, total] = await Promise.all([
      contract.balances(userAddress),
      contract.totalDeposited()
    ]);
    
    document.getElementById('userBalance').textContent = formatEther(userBal);
    document.getElementById('exitAmount').textContent = formatEther(userBal);
    document.getElementById('totalDeposited').textContent = formatEther(total);
  } catch (error) {
    console.error('Balance load error:', error);
  }
}

// Update Gas Estimates
async function updateDepositGas() {
  const amountInput = document.getElementById('depositAmount');
  if (amountInput.value > 0) {
    const wei = ethers.utils.parseEther(amountInput.value);
    const fee = await estimateGasAndFee(contract.deposit, wei);
    document.getElementById('depositGasFee').textContent = fee;
    document.getElementById('depositGas').classList.remove('hidden');
  } else {
    document.getElementById('depositGas').classList.add('hidden');
  }
}

async function updateExitGas() {
  const fee = await estimateGasAndFee(contract.exit);
  document.getElementById('exitGasFee').textContent = fee;
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  // Injected Wallets
  document.getElementById('metamaskBtn').addEventListener('click', connectInjected);
  document.getElementById('rainbowBtn').addEventListener('click', connectInjected);
  document.getElementById('coinbaseBtn').addEventListener('click', connectInjected);
  
  // WalletConnect
  document.getElementById('wcBtn').addEventListener('click', connectWalletConnect);
  
  // Disconnect
  document.getElementById('disconnectBtn').addEventListener('click', () => {
    location.reload();
  });
  
  // Deposit Input Change
  document.getElementById('depositAmount').addEventListener('input', updateDepositGas);
  
  // Deposit
  document.getElementById('depositBtn').addEventListener('click', async () => {
    const amountStr = document.getElementById('depositAmount').value;
    const amount = parseFloat(amountStr);
    if (!amount || amount <= 0) {
      showToast('Enter a valid amount > 0', 'error');
      return;
    }
    try {
      showLoading('depositBtn', true);
      const tx = await contract.deposit({ value: ethers.utils.parseEther(amountStr) });
      await tx.wait();
      showToast(`Deposited ${amount} MON`);
      document.getElementById('depositAmount').value = '';
      loadBalances();
      updateDepositGas();
    } catch (error) {
      showToast(`Deposit failed: ${error.message}`, 'error');
    } finally {
      showLoading('depositBtn', false);
    }
  });
  
  // Exit
  document.getElementById('exitBtn').addEventListener('click', async () => {
    try {
      const userBal = await contract.balances(userAddress);
      if (userBal.eq(0)) {
        showToast('No balance to withdraw', 'error');
        return;
      }
      showLoading('exitBtn', true);
      const tx = await contract.exit();
      await tx.wait();
      showToast('Withdrawal successful!');
      loadBalances();
      updateExitGas();
    } catch (error) {
      showToast(`Withdrawal failed: ${error.message}`, 'error');
    } finally {
      showLoading('exitBtn', false);
    }
  });
  
  // Auto-connect if possible
  if (window.ethereum && window.ethereum.selectedAddress) {
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId === MONAD_CHAIN.chainId) {
      connectInjected();
    }
  }
});
</script>
</body>
</html>
